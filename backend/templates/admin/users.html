{% extends "base.html" %}

{% block title %}User Management - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>User Management</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="exportUsers()">
                        <i class="fas fa-download"></i> Export Users
                    </button>
                    <button class="btn btn-primary" data-modal="addUserModal">
                        <i class="fas fa-plus"></i> Add User
                    </button>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="searchUsers" class="form-label">Search Users</label>
                                <input type="text" class="form-control" id="searchUsers" 
                                       placeholder="Search by name, email..." onkeyup="filterUsers()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterStatus" class="form-label">Status</label>
                                <select class="form-control" id="filterStatus" onchange="filterUsers()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="banned">Banned</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="filterPlan" class="form-label">Subscription Plan</label>
                                <select class="form-control" id="filterPlan" onchange="filterUsers()">
                                    <option value="">All Plans</option>
                                    <option value="free">Free</option>
                                    <option value="premium">Premium</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="filterDate" class="form-label">Date Range</label>
                                <select class="form-control" id="filterDate" onchange="filterUsers()">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h3>All Users</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Plan</th>
                                    <th>Status</th>
                                    <th>Documents</th>
                                    <th>Last Login</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" 
                                    data-status="{{ 'active' if user.is_active else 'inactive' }}"
                                    data-plan="{{ user.subscription_plan or 'free' }}"
                                    data-joined="{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else '' }}">
                                    <td>{{ user.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                {% if user.avatar_url %}
                                                <img src="{{ user.avatar_url }}" alt="Avatar" class="rounded-circle" width="32" height="32">
                                                {% else %}
                                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 32px; height: 32px; font-size: 14px;">
                                                    {{ user.name[0].upper() if user.name else user.email[0].upper() }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ user.name or 'No Name' }}</strong>
                                                {% if user.is_admin %}
                                                <span class="badge badge-warning ms-1">Admin</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        {% if user.subscription_plan == 'premium' %}
                                        <span class="badge badge-success">Premium</span>
                                        {% else %}
                                        <span class="badge badge-secondary">Free</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="badge badge-success">Active</span>
                                        {% else %}
                                        <span class="badge badge-danger">Inactive</span>
                                        {% endif %}
                                        {% if user.is_banned %}
                                        <span class="badge badge-danger">Banned</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge badge-info">{{ user.document_count or 0 }}</span>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                        {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                        Never
                                        {% endif %}
                                    </td>
                                    <td>{{ user.created_at.strftime('%Y-%m-%d') if user.created_at else 'N/A' }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" 
                                                    onclick="viewUser({{ user.id }})"
                                                    data-tooltip="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-{{ 'warning' if user.is_active else 'success' }}" 
                                                    onclick="toggleUserStatus({{ user.id }}, {{ user.is_active|lower }})"
                                                    data-tooltip="{{ 'Deactivate' if user.is_active else 'Activate' }}">
                                                <i class="fas fa-{{ 'pause' if user.is_active else 'play' }}"></i>
                                            </button>
                                            {% if not user.is_admin %}
                                            <button class="btn btn-sm btn-outline-{{ 'success' if user.is_banned else 'danger' }}" 
                                                    onclick="toggleBanStatus({{ user.id }}, {{ user.is_banned|lower }})"
                                                    data-tooltip="{{ 'Unban' if user.is_banned else 'Ban' }}">
                                                <i class="fas fa-{{ 'unlock' if user.is_banned else 'ban' }}"></i>
                                            </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-outline-info" 
                                                    onclick="changeUserPlan({{ user.id }}, '{{ user.subscription_plan or 'free' }}')"
                                                    data-tooltip="Change Plan">
                                                <i class="fas fa-crown"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- User Statistics -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-primary">{{ users|length }}</h3>
                            <p class="text-muted">Total Users</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-success">{{ users|selectattr('is_active')|list|length }}</h3>
                            <p class="text-muted">Active Users</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-warning">{{ users|selectattr('subscription_plan', 'equalto', 'premium')|list|length }}</h3>
                            <p class="text-muted">Premium Users</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="text-info">{{ users|sum(attribute='document_count') or 0 }}</h3>
                            <p class="text-muted">Total Documents</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal" id="addUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New User</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addUserForm" method="POST" action="/admin/users/add">
                <div class="form-group">
                    <label for="userName" class="form-label">Full Name *</label>
                    <input type="text" class="form-control" id="userName" name="name" required>
                </div>
                
                <div class="form-group">
                    <label for="userEmail" class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="userEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="userPassword" class="form-label">Password *</label>
                    <input type="password" class="form-control" id="userPassword" name="password" required>
                </div>
                
                <div class="form-group">
                    <label for="userPlan" class="form-label">Subscription Plan</label>
                    <select class="form-control" id="userPlan" name="subscription_plan">
                        <option value="free">Free</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="userIsAdmin" name="is_admin">
                        <label class="form-check-label" for="userIsAdmin">
                            Admin User
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="userIsActive" name="is_active" checked>
                        <label class="form-check-label" for="userIsActive">
                            Active User
                        </label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
            <button type="submit" form="addUserForm" class="btn btn-primary">Add User</button>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal" id="viewUserModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>User Details</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="userDetails">
            <!-- User details will be loaded here -->
        </div>
    </div>
</div>

<!-- Change Plan Modal -->
<div class="modal" id="changePlanModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Change User Plan</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="changePlanForm" method="POST" action="/admin/users/change-plan">
                <input type="hidden" id="changePlanUserId" name="user_id">
                
                <div class="form-group">
                    <label for="newPlan" class="form-label">New Subscription Plan</label>
                    <select class="form-control" id="newPlan" name="subscription_plan" required>
                        <option value="free">Free</option>
                        <option value="premium">Premium</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="planDuration" class="form-label">Plan Duration (for premium)</label>
                    <select class="form-control" id="planDuration" name="duration">
                        <option value="1">1 Month</option>
                        <option value="3">3 Months</option>
                        <option value="6">6 Months</option>
                        <option value="12">12 Months</option>
                        <option value="lifetime">Lifetime</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('changePlanModal')">Cancel</button>
            <button type="submit" form="changePlanForm" class="btn btn-primary">Update Plan</button>
        </div>
    </div>
</div>

<script>
function filterUsers() {
    const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
    const statusFilter = document.getElementById('filterStatus').value;
    const planFilter = document.getElementById('filterPlan').value;
    const dateFilter = document.getElementById('filterDate').value;
    
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const userId = row.dataset.userId;
        const status = row.dataset.status;
        const plan = row.dataset.plan;
        const joined = row.dataset.joined;
        
        let show = true;
        
        // Search filter
        if (searchTerm) {
            const text = row.textContent.toLowerCase();
            if (!text.includes(searchTerm)) {
                show = false;
            }
        }
        
        // Status filter
        if (statusFilter && status !== statusFilter) {
            show = false;
        }
        
        // Plan filter
        if (planFilter && plan !== planFilter) {
            show = false;
        }
        
        // Date filter
        if (dateFilter) {
            const today = new Date();
            const joinedDate = new Date(joined);
            let daysDiff = Math.floor((today - joinedDate) / (1000 * 60 * 60 * 24));
            
            switch (dateFilter) {
                case 'today':
                    if (daysDiff !== 0) show = false;
                    break;
                case 'week':
                    if (daysDiff > 7) show = false;
                    break;
                case 'month':
                    if (daysDiff > 30) show = false;
                    break;
            }
        }
        
        row.style.display = show ? '' : 'none';
    });
}

function viewUser(userId) {
    fetch(`/admin/users/${userId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const user = data.user;
            document.getElementById('userDetails').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>Basic Information</h5>
                        <p><strong>Name:</strong> ${user.name || 'No Name'}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Plan:</strong> ${user.subscription_plan || 'Free'}</p>
                        <p><strong>Status:</strong> ${user.is_active ? 'Active' : 'Inactive'}</p>
                        <p><strong>Admin:</strong> ${user.is_admin ? 'Yes' : 'No'}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Activity</h5>
                        <p><strong>Documents Created:</strong> ${user.document_count || 0}</p>
                        <p><strong>Last Login:</strong> ${user.last_login || 'Never'}</p>
                        <p><strong>Joined:</strong> ${user.created_at || 'Unknown'}</p>
                        <p><strong>Email Verified:</strong> ${user.email_verified ? 'Yes' : 'No'}</p>
                    </div>
                </div>
            `;
            showModal('viewUserModal');
        } else {
            DocumentToolkit.showAlert('danger', 'Failed to load user data');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        DocumentToolkit.showAlert('danger', 'Network error');
    });
}

function toggleUserStatus(userId, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    const message = `Are you sure you want to ${action} this user?`;
    
    if (!confirm(message)) return;
    
    fetch(`/admin/users/${userId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            DocumentToolkit.showAlert('success', `User ${action}d successfully!`);
            location.reload();
        } else {
            DocumentToolkit.showAlert('danger', data.message || 'Failed to update user status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        DocumentToolkit.showAlert('danger', 'Network error');
    });
}

function toggleBanStatus(userId, currentBanStatus) {
    const action = currentBanStatus ? 'unban' : 'ban';
    const message = `Are you sure you want to ${action} this user?`;
    
    if (!confirm(message)) return;
    
    fetch(`/admin/users/${userId}/toggle-ban`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            DocumentToolkit.showAlert('success', `User ${action}ned successfully!`);
            location.reload();
        } else {
            DocumentToolkit.showAlert('danger', data.message || 'Failed to update ban status');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        DocumentToolkit.showAlert('danger', 'Network error');
    });
}

function changeUserPlan(userId, currentPlan) {
    document.getElementById('changePlanUserId').value = userId;
    document.getElementById('newPlan').value = currentPlan;
    showModal('changePlanModal');
}

function exportUsers() {
    window.location.href = '/admin/users/export';
}

function showModal(modalId) {
    document.getElementById(modalId).classList.add('show');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('show');
}

// Close modals when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal')) {
        e.target.classList.remove('show');
    }
});
</script>
{% endblock %}
